filter {
    if [type] == "edgerouter" {
         mutate {
            remove_field => [ "[host]" ]
        }
        if [message] =~ "ubnt kernel" {
            mutate {
                add_tag => [ "firewall" ]
            }
            grok {
                match => { "message" => "^\<%{INT:priority}\>%{SYSLOGTIMESTAMP:ts} %{WORD:application} %{DATA:user}\: \[%{DATA:rule}\]IN=%{DATA:interface_in} OUT=%{DATA:interface_out} MAC=%{DATA:mac} SRC=%{DATA:source_ip} DST=%{DATA:destination_ip} LEN=%{INT:len} TOS=%{DATA:tos} PREC=%{DATA:prec} TTL=%{INT:ttl} ID=%{INT:id}( DF)? PROTO=%{WORD:proto} SPT=%{INT:source_port} DPT=%{INT:destination_port}" }
            }
            geoip {
                source => "source_ip"
                database => "/usr/share/GeoLite2-Country_20190122/GeoLite2-Country.mmdb"
            }
        } else {
            grok {
                match => { "message" => "^\<%{INT:priority}\>%{SYSLOGTIMESTAMP:ts} %{WORD:application} %{DATA:user}(\[.*\])?\:" }
            }
            if "session closed for user root" in [message] {
                drop { }
            }
            if "session opened for user root" in [message] {
                drop { }
            }
        }
    }
}

output {
    if [type] == "edgerouter" {
        if "firewall" in [tags] {
            elasticsearch {
                hosts => ["localhost:9200"]
                index => "edgerouter-firewall-%{+YYYY.MM.dd}"
            }
        } else {
            elasticsearch {
                hosts => ["localhost:9200"]
                index => "edgerouter-router-%{+YYYY.MM.dd}"
            }
        }
    }
}


